---
title: '[JVM]JVM中三色标记法'
tags:
  - JVM
  - GC
categories:
  - Java基础
slug: 2394647798
date: 2020-03-17 22:53:15
draft: true
---
三色标记算法是描述追踪式回收器的一种有用的方法，利用它可以推演回收器的正确性。对象分成三种类型:
* 黑色:根对象，或者该对象与它的子对象都被扫描
* 灰色:对象本身被扫描,但还没扫描完该对象中的子对象
* 白色:未被扫描对象，扫描完成所有对象之后，最终为白色的为不可达对象，即垃圾对象

根对象被置为黑色，子对象被置为灰色。
![upload successful](/images/pasted-115.png)
继续由灰色遍历,将已扫描了子对象的对象置为黑色。

![upload successful](/images/pasted-116.png)
遍历了所有可达的对象后，所有可达的对象都变成了黑色。不可达的对象即为白色，需要被清理。
![upload successful](/images/pasted-117.png)
这看起来很美好，但是如果在标记过程中，应用程序也在运行，那么对象的指针就有可能改变。这样的话，我们就会遇到一个问题：对象丢失问题

我们看下面一种情况，当垃圾收集器扫描到下面情况时：
![upload successful](/images/pasted-118.png)
```
A.c=C
B.c=null
```
这样，对象的状态图变成如下情形：
![upload successful](/images/pasted-119.png)
这时候垃圾收集器再标记扫描的时候就会下图成这样：
![upload successful](/images/pasted-120.png)

显然，C是白色的，也就是漏标了，会被当成垃圾回收掉，这对程序来说是不可以接受的。

漏标的情况只会发生在白色对象中，且满足以下任意一个条件：

1. 并发标记时，应用线程给一个黑色对象的引用类型字段赋值了该白色对象
2. 并发标记时，应用线程删除所有灰色对象到该白色对象的引用

事实上，方法1是CMS的实现关键，方法2是G1的实现关键，有关实现就移步[[JVM]CMS](/4242301031.html)和[[JVM]G1](/2687941502.html)
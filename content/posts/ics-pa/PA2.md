---
title: "PA2"
date: 2023-03-25T00:38:48+08:00
draft: false
slug: 3792c313
---
## ä¸åœè®¡ç®—çš„æœºå™¨
### ç†è§£YEMUå¦‚ä½•æ‰§è¡Œç¨‹åº

ï¼ˆåªç”»å‡ºäº†æœ‰å˜åŒ–çš„éƒ¨åˆ†ï¼Œæ¯ä¸€è¡Œçš„çŠ¶æ€æ˜¯æ³¨é‡Šé‡Œçš„æŒ‡ä»¤æ‰§è¡Œåçš„çŠ¶æ€

    R[0] 0000 0000 R[1] 0000 0000                  // init
    R[0] 0001 0000 R[1] 0000 0000                  // load  6#     | R[0] <- M[y]
    R[0] 0001 0000 R[1] 0001 0000                  // mov   r1, r0 | R[1] <- R[0]
    R[0] 0010 0001 R[1] 0001 0000                  // load  5#     | R[0] <- M[x]
    R[0] 0011 0001 R[1] 0001 0000                  // add   r0, r1 | R[0] <- R[0] + R[1]
    R[0] 0011 0001 R[1] 0001 0000 M[7] = 0011 0001 // store 7#     | M[z] <- R[0]

## RTFSC(2)
### ç«‹å³æ•°èƒŒåçš„æ•…äº‹
å¦‚æœæŠŠå†…å­˜åœ°å€æŒ‰æ ˆæ‘†æ”¾å°±æ˜¯è¿™æ ·ï¼Œè§£é‡ŠæŒ‡é’ˆæ—¶æ˜¯ä»ä½åœ°å€å¾€é«˜åœ°å€è§£é‡Šçš„ï¼Œæ‰€ä»¥å°ç«¯åœ¨æ•°å€¼è½¬æ¢æ¯”è¾ƒæ–¹ä¾¿ï¼Œæ¯”å¦‚32ä½æ•°`0x1234`è¦è§£é‡Šä¸º8ä½æ•°å­—ï¼Œåªéœ€è¦è§£é‡ŠæŒ‡é’ˆçš„æ—¶ä¾¯å–ç¬¬ä¸€ä¸ªå­—èŠ‚å³å¯ã€‚

```
    +----+
x+3 | 00 |
    +----+
x+2 | 00 |
    +----+
x+1 | 12 |
    +----+
x   | 34 |
    +----+
```

* è¿è¡Œåœ¨**Motorola 68k**æ¶æ„çš„å¤„ç†å™¨æ—¶ï¼Œ**è¯»å–ç«‹å³æ•°**åº”è¯¥æŒ‰æ•°æ®å®½åº¦è¯»å–nä¸ªå­—èŠ‚ï¼Œç„¶åå°†å­—èŠ‚æ•°ç»„é€†åºï¼ŒæŒ‰å¤§ç«¯å­˜å‚¨
* æ¨¡æ‹Ÿ**Motorola 68k**æ¶æ„æ—¶ï¼Œ**è¯»å–ç«‹å³æ•°**åº”è¯¥æŒ‰æ•°æ®å®½åº¦è¯»å–nä¸ªå­—èŠ‚ï¼Œç„¶åå°†å­—èŠ‚æ•°ç»„é€†åºï¼ŒæŒ‰å°ç«¯å­˜å‚¨

### ç«‹å³æ•°èƒŒåçš„æ•…äº‹(2)
~~æŒ‡ä»¤é•¿åº¦åªæœ‰32ä½ï¼Œç›²çŒœæ˜¯ç”¨åˆ†é¡µçš„æ€æƒ³ï¼ŒæŠŠä½ä½å’Œé«˜ä½æ‹†å¼€ï¼Œä¸€éƒ¨åˆ†æ”¾å¯„å­˜å™¨é‡Œï¼Œåˆ©ç”¨å¯„å­˜å™¨åšç´¢å¼•ã€‚ï¼ˆå¾…æ±‚è¯~~  
é«˜ä½ä½ä½æ‹†å¼€ï¼Œç„¶åç”¨ä¸€ä¸ªåŠ æ³•ç›¸åŠ 

### RTFSCç†è§£æŒ‡ä»¤æ‰§è¡Œçš„è¿‡ç¨‹

åŸºæœ¬å°±æ˜¯ä¸‹å›¾çš„æµç¨‹ä¸åœåœ°é‡å¤ï¼Œ

![](/images/20230328004004.png)

(å…¶å®è¿™æ˜¯x86çš„ï¼Œè™½ç„¶x86çš„æŒ‡ä»¤åŸºæœ¬å®ç°å®Œäº†ï¼Œä½†å½“æˆ‘ç”¨QEMUæ­»æ´»è·‘ä¸äº†diffteståï¼Œæˆ‘å°±è½¬æˆ˜riscv32äº†ğŸ˜Š)

### ä¸ºä»€ä¹ˆæ‰§è¡Œäº†æœªå®ç°æŒ‡ä»¤ä¼šå‡ºç°ä¸Šè¿°æŠ¥é”™ä¿¡æ¯
æµç¨‹å›¾`switch(opcode)`è¿™ä¸€æ­¥ï¼Œå¦‚æœæ²¡æœ‰å®ç°å¯¹åº”æŒ‡ä»¤ï¼Œä¼šèµ°åˆ°`default`åˆ†æ”¯ï¼Œæ‰§è¡Œ`exec_inv`

### è¿è¡Œç¬¬ä¸€ä¸ªå®¢æˆ·ç¨‹åº
![](/images/20230409123932.png)

### å…¶ä»–

### æ•°çš„æ‰©å±•
ç”±äºNEMUçš„æ•°æ®å®½åº¦éƒ½æ˜¯ç”¨`word_t`/`sword_t`ï¼Œå¸¦ç¬¦å·æ•°åº”è¯¥ç”¨`sword_t`è¡¨ç¤ºã€‚riscv32çš„`sword_t`æ˜¯4ä¸ªå­—èŠ‚ï¼Œå¦‚æœæ“ä½œæ•°ä¸æ˜¯4ä¸ªå­—èŠ‚ï¼Œéœ€è¦åšç¬¦å·æ‰©å±•ï¼Œç”¨åˆ°çš„rtlå‡½æ•°æ˜¯`rtl_sext`ï¼Œå¯ä»¥åˆ©ç”¨ä½åŸŸæ¥å®ç°ï¼Œç”¨åˆ°çš„å®æ˜¯

```c
#define SEXT(x, len) ({ struct { int64_t n : len; } __x = { .n = x }; (int64_t)__x.n; })
```
å…¶ä¸­lenæ˜¯æœ€é«˜ä½çš„ä½ç½®ï¼ˆä»1å¼€å§‹ï¼‰

### `HIT BAD TRAP`
å„ç§ç¼–ç çš„å°é©¬è™ï¼Œéƒ½å¯èƒ½ä¼šå¯¼å‘`HIT BAD TRAP`ï¼Œæ‰€ä»¥æ‰‹å†ŒæŒ‡ä»¤æè¿°åº”è¯¥çœ‹ä»”ç»†ï¼Œå¯ä»¥å°‘èµ°å¼¯è·¯ã€‚

~~å¦å¤–å°±æ˜¯å¯¹æŒ‡ä»¤çš„ä¸ç†Ÿæ‚‰ä¹Ÿä¼šè¸©å‘ã€‚ä½†æˆ‘ä»¬é”»ç‚¼çš„èƒ½åŠ›å°±æ˜¯å¦‚ä½•åœ¨ä¸ç†Ÿæ‚‰çš„å‰æä¸‹ç¼–ç¨‹ï¼Œ~~

~~å½“é‡åˆ°`HIT BAD TRAP`ï¼Œå»è¯»æ‡‚å…¨éƒ¨æŒ‡ä»¤é€»è¾‘çš„è¯æˆæœ¬å¤ªé«˜ï¼ˆåˆä¸æ˜¯æé€†å‘çš„ï¼‰ï¼Œå¯ä»¥æŸ¥çœ‹**nemu-log.txt**(buildç›®å½•ä¸‹)ï¼Œå¤§çº¦å®šä½åˆ°`check`å¤±è´¥çš„æ¡ä»¶ï¼Œé¡ºç€æ¡ä»¶å›æº¯ï¼Œæ‰¾åˆ°`eflags`ä¸ç¬¦åˆé¢„æœŸçš„pcï¼Œä»è€Œå®šä½åˆ°å“ªæ¡æŒ‡ä»¤å®ç°æœ‰é—®é¢˜~~

~~å…·ä½“æ€ä¹ˆåšå‘¢ï¼ŒåŸºç¡€è®¾æ–½çš„å®ç°å°±å¯ä»¥å¸®åˆ°ä½ äº†ï½~~

çœ‹æ¥PAè¦å®Œæ•´åœ°çœ‹ã€‚ã€‚ã€‚ç¬¬å››èŠ‚çš„**åŸºç¡€è®¾æ–½**æœ‰`DiffTest`ã€‚ã€‚ã€‚

### è§£ææŒ‡ä»¤
å†™äº†ä¸ª`riscv`å‘½ä»¤ç”¨äºè§£æriscvæŒ‡ä»¤ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

    (nemu) riscv f61ff0ef
    
    1111011 ????? ????? 111 ????? 1101111

### mulh
åŒæœ‰ç¬¦å·åŠ æ³•ä¸€æ ·ï¼Œæœ‰ç¬¦å·ä¹˜æ³•ä¹Ÿæ˜¯æŠŠè´Ÿæ•°ç”¨è¡¥ç è¡¨ç¤ºï¼Œå…å»äº†å•ç‹¬è®¡ç®—ç¬¦å·ä½çš„é—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯æœ‰ç¬¦å·è¿ç®—å’Œæ— ç¬¦å·è®¡ç®—çš„åŒºåˆ«ï¼Œæ— ç¬¦å·è®¡ç®—å¼€ç®±å³ç”¨ï¼Œæœ‰ç¬¦å·æ•°éœ€è¦å…ˆå¯¹è´Ÿæ•°è½¬è¡¥ç ï¼ˆæ­£æ•°çš„è¡¥ç å³åŸç ï¼Œæ— éœ€è½¬æ¢ï¼‰

## ç¨‹åº, è¿è¡Œæ—¶ç¯å¢ƒä¸AM
### è¿™åˆèƒ½æ€ä¹ˆæ ·å‘¢
è¿™ç§è®¾è®¡åŸåˆ™å…¶å®æ˜¯`DIP`[ä¾èµ–åè½¬åŸåˆ™](https://en.wikipedia.org/wiki/Dependency_inversion_principle)ï¼Œéµå¾ªè¿™ä¸ªåŸåˆ™å°±å¯ä»¥åšåˆ°è§£è€¦ã€‚å…·ä½“åœ°ï¼Œé«˜å±‚æ¬¡ä¸åº”è¯¥å¼•å…¥ä½å±‚æ¬¡çš„é€»è¾‘ï¼Œé«˜å±‚æ¬¡å’Œä½å±‚æ¬¡ä¹‹é—´çš„æ²Ÿé€šåº”è¯¥é€šè¿‡æŠ½è±¡æ¥å®Œæˆï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸‹è¿™ä¸ªæŠ½è±¡å°±æ˜¯`halt()`ã€‚

### ä¸ºä»€ä¹ˆè¦æœ‰AM? (å»ºè®®äºŒå‘¨ç›®æ€è€ƒ)
> All problems in computer science can be solved by another level of [indirection](https://en.wikipedia.org/wiki/Indirection)

AMæä¾›ä¸€ä¸ªruntimeï¼Œå……å½“å®¢æˆ·ç¨‹åºå’Œç›®æ ‡æ¶æ„çš„ä¸­é—´å±‚ï¼Œè¿™ä¸ªç›®æ ‡æ¶æ„å¯ä»¥æ˜¯`$ISA-nemu`ï¼Œå¯ä»¥æ˜¯`native`ã€‚

ä»¥`klib`ä¸ºä¾‹ï¼Œç”¨`x86-gcc`ç¼–è¯‘çš„ç¨‹åºï¼ŒåŠ¨æ€é“¾æ¥çš„`stdlib`æ˜¯`x86`æ¶æ„çš„ã€‚å¦‚æœç”¨`riscv-gnu-toolchain`æŠŠç¨‹åºé“¾æ¥åˆ°`x86`çš„`stdlib`ï¼Œä¸€ä¸ªelfå°±ä¼šå‡ºç°ä¸¤ç§ABIï¼Œå¥½æ¯”æˆ‘ä»¬rpcæ˜¯ä¸¤ç§åè®®åœ¨è·‘ï¼Œå¦‚æœæ²¡æœ‰ä¸­é—´å±‚ï¼Œæˆ‘æƒ³è¿™æ˜¯è·‘ä¸èµ·æ¥çš„ã€‚

æ‰€ä»¥AMéœ€è¦æä¾›æ ‡å‡†åº“çš„è¿è¡Œç¯å¢ƒï¼Œéœ€é‡æ–°ç¼–è¯‘`glibc`åˆ°ç›®æ ‡æ¶æ„ï¼Œè¿™æ ·æœ€ç»ˆçš„é•œåƒæ‰èƒ½æ­£å¸¸è¿è¡Œï¼ˆå½“ç„¶å…·ä½“å®ç°ä½ å¯ä»¥ç›´æ¥æŠŠ`glibc`çš„æºç copyè¿‡æ¥ğŸ¤“ï¼‰


> vmwareä¹Ÿæ˜¯è™šæ‹Ÿæœºï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨æ—¶ä¸éœ€è¦é‡æ–°ç¼–ä¸€ä¸ªisoé•œåƒï¼Ÿå› ä¸ºvmwareæ²¡æœ‰è·¨isaã€‚å¦‚æœè·¨äº†isaï¼Œä½ æƒ³åœ¨m1çš„macä¸Šè¿è¡Œä¸€ä¸ªx86ç¨‹åºï¼Œé€šè¿‡vmwareæ˜¯ä¸è¡Œçš„ï¼Œè€Œé€šè¿‡äº¤å‰ç¼–è¯‘å’Œ[qemu](https://www.qemu.org/)ä½ å°±å¯ä»¥åšåˆ°ã€‚

### stdargæ˜¯å¦‚ä½•å®ç°çš„?
è¿™ä¸ªå¤´æ–‡ä»¶æœ€å¸¸ç”¨ç”¨äºå¯å˜å‚æ•°è§£æ

æœ€å¸¸è§çš„å‚æ•°å‡½æ•°ä¼ é€’æ–¹å¼å°±æ˜¯ç”¨**å¯„å­˜å™¨/æ ˆ**ä¼ é€’å‚æ•°ï¼ŒæŒ‰å‚æ•°åˆ—è¡¨ä»å³åˆ°å·¦çš„é¡ºåºå‹æ ˆã€‚

ä¸€èˆ¬å¯å˜å‚æ•°éƒ½æœ‰ä¸€ä¸ªå‚æ•°ç”¨äºè¡¨æ˜å‚æ•°ä¸ªæ•°ï¼Œæ¯”å¦‚`printf`çš„`format`å°±é€šè¿‡è½¬ä¹‰ç¬¦å·æŒ‡ç¤ºäº†å‚æ•°ä¸ªæ•°å’Œç±»å‹ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ`printf`ä½¿ç”¨æœ‰é”™è¯¯çš„è¯å¯ä»¥åœ¨ç¼–è¯‘æœŸæŠ¥é”™ï¼‰ã€‚çŸ¥é“äº†å‚æ•°ä¸ªæ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»**å¯„å­˜å™¨/æ ˆ**æŒ‰é¡ºåºç§»åŠ¨æŒ‡é’ˆï¼ŒæŒ‰ç±»å‹å–å‡ºå‚æ•°äº†ã€‚

## åŸºç¡€è®¾æ–½
### æ¶ˆå¤±çš„ç¬¦å·
å®æ›¿æ¢åå°±ä¸åœ¨äº†ï¼Œæ‰€ä»¥å®ä¸æ˜¯ç¬¦å·ï¼ˆå½“ç„¶å®å¯ä»¥äº§ç”Ÿç¬¦å·

å‚æ•°é€šè¿‡æ ˆå’Œå¯„å­˜å™¨ä¼ é€’ï¼Œæ‰€ä»¥ä¸éœ€è¦ç¬¦å·

### å¯»æ‰¾"Hello World!"
å…ˆäº§å‡ºç›®æ ‡æ–‡ä»¶hello

ç„¶å`hd`æŸ¥æ‰¾elfæ–‡ä»¶çš„"Hello World!"åœ°å€

å†æ‰§è¡Œ
```shell
readelf --section-headers hello
```
ç¡®å®šå­—ç¬¦ä¸²çš„åœ°å€ï¼Œå¯ä»¥ä»`section header`é‡Œæ‰¾åˆ°è¿™ä¸ªåœ°å€å±äº`.rodata`èŠ‚ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹éªŒè¯
```shell
â¯ readelf -p .rodata hello

String dump of section '.rodata':
  [     0]  Hello World!
```
`.rodata`(`read-only data`)æ”¾çš„æ˜¯å¸¸é‡æ•°æ®

### å®ç°ftrace
> å¦‚æœä½ é€‰æ‹©çš„æ˜¯riscv32, ä½ è¿˜éœ€è¦è€ƒè™‘å¦‚ä½•ä»jalå’ŒjalræŒ‡ä»¤ä¸­æ­£ç¡®è¯†åˆ«å‡ºå‡½æ•°è°ƒç”¨æŒ‡ä»¤å’Œå‡½æ•°è¿”å›æŒ‡ä»¤

`jal`å’Œ`jalr`æŒ‡ä»¤çš„`rd`å¯„å­˜å™¨æ˜¯`ra`æ—¶ï¼Œå¯ä»¥çœ‹ä½œ`call`çš„å®ç°ï¼Œè¿™æ˜¯[riscvçš„è°ƒç”¨çº¦å®š](https://inst.eecs.berkeley.edu/~cs61c/resources/RISCV_Calling_Convention.pdf)
`jalr`çš„`rs1`å¯„å­˜å™¨æ˜¯`ra`æ—¶ï¼Œå¯ä»¥çœ‹ä½œ`ret`çš„å®ç°

### ä¸åŒ¹é…çš„å‡½æ•°è°ƒç”¨å’Œè¿”å›
é€’å½’å¯èƒ½ä¼šå¯¼è‡´`call`å’Œ`ret`ä¸åŒ¹é…ï¼ˆè¿˜æ²¡æƒ³æ¸…æ¥š

### å†—ä½™çš„ç¬¦å·è¡¨
1. èƒ½æ‰§è¡ŒæˆåŠŸ
1. ä¸èƒ½é“¾æ¥æˆåŠŸï¼ŒæŠ¥é”™ï¼š```(.text+0x20): undefined reference to `main` ```

é“¾æ¥æ˜¯éœ€è¦ä¾é ç¬¦å·è¡¨æ¥å®šä½å®šä½ç¬¦å·çš„ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰ç¬¦å·è¡¨ï¼Œå¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œgccä¸çŸ¥é“mainå‡½æ•°åœ¨å“ªä¸ªä½ç½®ï¼Œä¹Ÿå°±ä¸çŸ¥é“ç¨‹åºçš„å…¥å£åº”è¯¥ä»å“ªé‡Œå¼€å§‹ï¼Œæ— æ³•å®Œæˆé“¾æ¥ã€‚

### å¦‚ä½•ç”Ÿæˆnativeçš„å¯æ‰§è¡Œæ–‡ä»¶
ä»¥`/am-kernels/tests/cpu-tests/tests/string.c`ä¸ºä¾‹ï¼Œä¸åŒçš„`ARCH`ä¼ å…¥`Makefile`åï¼Œå¯ä»¥ç”¨äºè·¯ç”±åˆ°ä¸åŒçš„`Makefile`(abstract-machine/scripts)ï¼Œä¸»è¦æ˜¯æ˜¯ç¼–è¯‘çš„æºæ–‡ä»¶æœ‰åŒºåˆ«ã€‚

ç¼–è¯‘`ARCH=native`ç”¨çš„æ˜¯`gcc`å¥—ä»¶ï¼Œå…¥å£å°±æ˜¯é•œåƒçš„`main`ï¼Œæ‰€ä»¥`native`ä¸ä¼šæœ‰NEMUçš„é‚£äº›è¾“å‡º(å…¶å®`init_platform()` ä¼šæ¯”`main`æ›´æ—©æ‰§è¡Œï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°æ ‡æ³¨äº†`__attribute__((constructor))`)

ç¼–è¯‘`ARCH=riscv32-nemu`ç”¨çš„æ˜¯`riscv-gnu-toolchain`ï¼Œå…¥å£æ˜¯NEMUçš„`main`ï¼Œç„¶åå†ä»é•œåƒä½œä¸ºæ•°æ®ï¼Œä»`main`è§£é‡Šæ‰§è¡Œ(ç”¨riscv32çš„æ–¹å¼è§£é‡Š)

P.S. ç¼–è¯‘`ARCH=$ISA-nemu`çš„é•œåƒæ—¶ï¼Œå³ä½¿ç”¨äº†`-g`ã€`-ggdb3`é€‰é¡¹ï¼Œ`gdb`ä¹Ÿè¯»å–ä¸äº†è°ƒè¯•ä¿¡æ¯ã€‚æƒ³å¯¹é•œåƒæœ¬èº«è°ƒè¯•çš„è¯ï¼Œåªèƒ½é€šè¿‡NEMUçš„åŸºç¡€è®¾æ–½æˆ–è€…ä½¿ç”¨`ARCH=native`ã€‚

### è¿™æ˜¯å¦‚ä½•å®ç°çš„?
```c
// abstract-machine/klib/src/string.c
#if !defined(__ISA_NATIVE__) || defined(__NATIVE_USE_KLIB__)
```
è¿™ä¸€è¡Œçš„æ„æ€æ˜¯ï¼Œå¦‚æœé€‰äº†é`native`æ¶æ„ï¼Œæˆ–`native`+`klib`ï¼Œå°±è¦ç”¨è‡ªå®šä¹‰çš„`stdlib`å®ç°

ä¸ºä»€ä¹ˆå®šä¹‰äº†å°±èƒ½è¦†ç›–`glibc`å®ç°?

é€šè¿‡`make -n`æŸ¥çœ‹`make`è¿‡ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ç¼–è¯‘`klib`å•å…ƒçš„æ—¶å€™ç”¨ä¸Šäº†`-fno-builtin`ï¼Œ`man gcc`å¯ä»¥çœ‹åˆ°è¿™ä¸ªé€‰é¡¹çš„ä½œç”¨

> Don't recognize built-in functions that do not begin with __builtin_ as prefix.

äº‹å®ä¸Šï¼Œå¦‚æœä½ æ²¡æœ‰æä¾›å†…ç½®å‡½æ•°çš„å®ç°ï¼Œé‚£ä¹ˆé“¾æ¥æ—¶è¿˜æ˜¯ä¼šåˆ°`glibc`æŸ¥æ‰¾å®ç°ã€‚

### å¥‡æ€ªçš„é”™è¯¯ç 
å¯èƒ½æ³¨å†Œäº†ä¿¡å·å¤„ç†å‡½æ•°ï¼Œæ‰§è¡Œäº†`exit(1)`ï¼ˆå¾…æ±‚è¯

### ç¼–å†™æ›´å¤šçš„æµ‹è¯•(2)
ç”¨`native`+`gblic`çš„è¿è¡Œç¯å¢ƒè·‘æµ‹è¯•ç”¨ä¾‹çš„ç»“æœï¼Œå†ç”¨`native`+`klib`æµ‹è¯•ï¼Œæœ€åç”¨`$ISA-nemu`+`klib`æµ‹è¯•

### ç¼–å†™æ›´å¤šçš„æµ‹è¯•(3)
ç•¥ã€‚

### æ•æ‰æ­»å¾ªç¯(æœ‰ç‚¹éš¾åº¦)
ä¸èƒ½ï¼Œæ­£å¦‚åƒä¸‰ç»´ç”Ÿç‰©ç†è§£ä¸äº†å››ç»´ä¸€æ ·ã€‚

è¿™å…¶å®æ˜¯ä¸ªè‘—åçš„åœæœºé—®é¢˜([Halting Problem](https://en.wikipedia.org/wiki/Halting_problem))

### ç†è§£volatileå…³é”®å­—
`_end`åº”è¯¥æ˜¯æŒ‡ç»ˆç«¯ã€‚

`volatile`ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Œå¦‚æœå»æ‰`volatile`ï¼Œå¯¹`*p`çš„èµ‹å€¼ä»£ç å¯èƒ½ä¼šä¹±åºï¼Œç”šè‡³æ¶ˆé™¤æ‰è¿™äº›æ— æ„ä¹‰çš„ä»£ç ã€‚

å¦‚æœ`_end`æ˜¯è®¾å¤‡å¯„å­˜å™¨ï¼Œè®¾å¤‡ä¼šæ”¶åˆ°ä¹±åºæ•°æ®ç”šè‡³æ²¡æ”¶åˆ°æ•°æ®ã€‚

P.S. `volatile`çš„è¯­ä¹‰åœ¨`C`å’Œ`java`é‡Œä¸å®Œå…¨ä¸€æ ·ï¼Œ`C`é‡Œé¢çš„`volatile`è¯­ä¹‰ç®€å•çš„å¤šï¼Œæ¯”å¦‚ä¸ä¿è¯**å†…å­˜å¯è§æ€§**

### ç†è§£mainargs
#### $ISA-nemu
åœ¨makefileå‚æ•°è½¬ä¸ºå®ï¼Œåœ¨é™æ€å˜é‡å±•å¼€
```makefile
CFLAGS += -DMAINARGS=\"$(mainargs)\"
```
```c
#ifndef MAINARGS
#define MAINARGS ""
#endif
static const char mainargs[] = MAINARGS;
```
#### native
```c
// abstract-machine/am/src/native/platform.c
const char *args = getenv("mainargs");
halt(main(args ? args : "")); // call main here!
```
ä»è¿™é‡Œçš„ç¯å¢ƒå˜é‡è·å¾—ï¼ˆmakeçš„å‚æ•°ä¼šä½œä¸ºè¿›ç¨‹çš„ç¯å¢ƒå˜é‡

### RTFSCå°½å¯èƒ½äº†è§£ä¸€åˆ‡ç»†èŠ‚
`make ARCH=riscv32-nemu mainargs=t run`

### RTFSCäº†è§£ä¸€åˆ‡ç»†èŠ‚
![](/images/20230511190813.png)
è·‘åˆ†è¿™ä¹ˆé«˜ï¼Œçœ‹æ¥æˆ‘å¾ˆç‰›é€¼ï¼ˆè¯¯

ä¸‹é¢æ˜¯`native`è·‘åˆ†
![](/images/20230511191536.png)

å¾—æ¥æ‰¾æ‰¾å“ªé‡Œæœ‰é—®é¢˜ï¼Œä»¥å…è¿·å¤±è‡ªæˆ‘ã€‚åˆ†æ•°æœ‰é—®é¢˜ï¼Œé‚£å¤§æ¦‚æ˜¯è·å–çš„æ—¶é—´æœ‰é—®é¢˜ï¼Œç›´æ¥ç”¨**difftest**çš„æ€æƒ³ï¼Œç¥­å‡º`printf`å¤§æ³•å¯¹æ¯”NEMUçš„å€¼å’ŒAMçš„å€¼ï¼Œä¸¤ä¸ªåœ°æ–¹çš„è¾“å‡ºæœç„¶ä¸ä¸€æ ·ã€‚

![](/images/20230512010214.png)

çœ‹èµ·æ¥AMæ¯æ¬¡è¯»åˆ°çš„å€¼éƒ½æ˜¯NEMUä¸Šä¸€æ¬¡è¯»åˆ°çš„å€¼

AMä»£ç :

```c
void __am_timer_uptime(AM_TIMER_UPTIME_T *uptime) {
  // è¿™é‡Œuså’Œrtc_io_handleré‡Œçš„usä¸ä¸€æ ·
  uptime->us = (uint64_t) inl(RTC_ADDR) | ((uint64_t) inl(RTC_ADDR + 4)) << 32;
}
```
NEMUä»£ç :

```diff
diff --git a/nemu/src/device/timer.c b/nemu/src/device/timer.c
index 2aff819..f1f02d6 100644
--- a/nemu/src/device/timer.c
+++ b/nemu/src/device/timer.c
@@ -21,7 +21,7 @@ static uint32_t *rtc_port_base = NULL;
 
 static void rtc_io_handler(uint32_t offset, int len, bool is_write) {
   assert(offset == 0 || offset == 4);
-  if (!is_write && offset == 4) {
+  if (!is_write && offset == 0) {
     uint64_t us = get_time();
     rtc_port_base[0] = (uint32_t)us;
     rtc_port_base[1] = us >> 32;
```
è¿™é‡Œåˆ¤æ–­äº†`offset`çš„å€¼é˜²æ­¢è¿ç»­çš„æ›´æ–°ã€‚å› ä¸ºAMå…ˆè¯»çš„ä½å­—èŠ‚çš„ï¼Œå¯¼è‡´æ²¡æœ‰æ›´æ–°ä½å­—èŠ‚å¯„å­˜å™¨ã€‚

### å®ç°IOE(2)
æœ€é«˜ä½æ˜¯`keydown`, å…¶ä½™ä½æ˜¯`keycode`
```c
void __am_input_keybrd(AM_INPUT_KEYBRD_T *kbd) {
  int k = inl(KBD_`ADDR`);
  kbd->keydown = (k & KEYDOWN_MASK ? true : false);
  kbd->keycode = k & ~KEYDOWN_MASK;
}
```
è®°å¾—æŠŠVGAçš„æ‰€æœ‰é€‰é¡¹æ‰“å¼€ã€‚ã€‚ä¸ç„¶æ²¡æœ‰å±å¹•ã€‚ã€‚

### å¦‚ä½•æ£€æµ‹å¤šä¸ªé”®åŒæ—¶è¢«æŒ‰ä¸‹?
é”®ç›˜è¾“å‡ºä¸€æ¬¡åªæœ‰ä¸€ä¸ªï¼Œæ¯æ¬¡æ¥å—åˆ°è¾“å…¥äº‹ä»¶æ—¶ï¼ŒæŠŠkeycodeç¼“å­˜åˆ°é˜Ÿåˆ—é‡Œï¼ŒçŸ­æ—¶é—´å†…é˜Ÿåˆ—é‡Œçš„æŒ‰é”®è§†ä¸ºä¸€ä¸ªç»„åˆã€‚

### ç¥å¥‡çš„è°ƒè‰²æ¿
åªè¦æ”¹å˜éœ€è¦æ·¡å…¥æ·¡å‡ºçš„é‚£éƒ¨åˆ†ç´¢å¼•çš„é¢œè‰²æ¿ï¼Œå°±å¯ä»¥å®ç°æ·¡å…¥æ·¡å‡º

### å®ç°IOE(3)
#### åŒæ­¥å¯„å­˜å™¨
å½“æ‰§è¡Œ`outl(SYNC_ADDR, 1);`ï¼Œä¼šæŠŠåŒæ­¥å¯„å­˜å™¨æ˜ å°„çš„å†…å­˜`SYNC_ADDR`å†™ä¸º1

åœ¨`vga_update_screen`åˆ¤æ–­`vgactl_port_base[1]`ä¸º1æ—¶ï¼Œæ‰§è¡Œ`update_screen`ï¼Œå¹¶ç½®ä¸º0ã€‚

#### å±å¹•å¤§å°å¯„å­˜å™¨
AMè¯»å–`VGACTL_ADDR`ï¼Œç”±NEMUè½¬å‘åˆ°`vgactl_port_base[0]`

#### display test
æµ‹è¯•çš„ç¡®æ˜¯æ‰§è¡ŒæˆåŠŸäº†ï¼Œä½†æ˜¯FPSåªæœ‰4ã€‚ã€‚ã€‚

æœ€å…ˆæƒ³åˆ°çš„æ˜¯`memcpy`ï¼Œbyte-by-byteçš„æ–¹å¼æ¯”è¾ƒæ…¢ï¼Œå› ä¸ºé€‰çš„æ˜¯`risv32`ï¼Œæ‰€ä»¥é‡‡å–4å­—èŠ‚æ‰¹é‡å¤åˆ¶çš„æ–¹å¼ï¼Œæœ€åå†æŒ‰å­—èŠ‚å¤åˆ¶ã€‚ï¼ˆå³ä½¿ä¸€æ¬¡å¤åˆ¶8ä¸ªå­—èŠ‚ï¼Œç¼–è¯‘åä¹Ÿæ˜¯æŒ‰4ä¸ªå­—èŠ‚å¤åˆ¶ï¼‰
> ä¼˜åŒ–å®Œæ‰7FPSã€‚ã€‚ã€‚

### æ¸¸æˆæ˜¯å¦‚ä½•è¿è¡Œçš„
```c
struct character {
  char ch;
  int x, y, v, t;
} chars[NCHAR];
```
`struct character`: å­—ç¬¦çŠ¶æ€ã€‚å‡†ç¡®åœ°è¯´æ˜¯ä¸ªæ± å­ï¼Œç”³è¯·æ–°å­—ç¬¦çš„æ—¶å€™ï¼Œä»æ± å­æŒ‘ä¸€ä¸ªå¯ç”¨çš„å¹¶éšæœºä¸€ä¸ªå­—æ¯èµ‹å€¼ç»™`ch`ã€‚ç”±äºå­—ç¬¦çš„widthã€heightæ˜¯å›ºå®šçš„ï¼Œåªç»´æŠ¤äº†`(x,y)`ä¸€ä¸ªåæ ‡ï¼Œ`v`æ˜¯é€Ÿåº¦ï¼Œæ¯ä¸€å¸§`y`éƒ½è¦å‡å»`v`ï¼Œ`t`åœ¨å­—ç¬¦è§¦åº•çš„æ—¶å€™ä¼šæ‰§è¡Œ`c->t = FPS`ï¼Œåº”è¯¥æ˜¯è¡¨ç¤ºè®©è§¦åº•çš„å­—ç¬¦æš‚ç•™è¿™ä¹ˆå¤šå¸§ã€‚

`texture[][][]`: æ–‡æœ¬è¡¨ã€‚ä¸‰ç»´åˆ†åˆ«æ˜¯ï¼šColor, Letter, å­—ä½“ä½å›¾ï¼ˆé•¿åº¦ä¸ºCHAR_H*CHAR_Wï¼‰

`static int x[NCHAR], y[NCHAR], n = 0;`: ä¸Šä¸€æ¬¡`render`çš„`(x,y)`åˆ—è¡¨ï¼Œç”¨äºæ¢å¤èƒŒæ™¯è‰²

#### è¿è¡Œè¿‡ç¨‹
ç®€å•åœ°è¯´ï¼Œè¿™ä¸ªæ¸¸æˆé€šè¿‡æ­»å¾ªç¯:
1. æ ¹æ®å¸§å·`frames`æ›´æ–°`chars`å­—ç¬¦çŠ¶æ€
2. å¯¹`AM_INPUT_KEYBRD`å¯„å­˜å™¨pollé”®ç›˜äº‹ä»¶ï¼Œå¯¹`chars`å¯¹åº”çš„å­—ç¬¦è¿›è¡Œæ¸…é™¤ï¼Œ
3. å°†ä¸Šä¸€æ¬¡`render`çš„`(x,y)`åˆ—è¡¨æ¢å¤ä¸ºèƒŒæ™¯è‰²
4. æ ¹æ®`chars`å¾€`AM_GPU_FBDRAW`å¯„å­˜å™¨å†™å…¥æœ€æ–°çš„å­—ç¬¦å›¾åƒ

### LiteNESå¦‚ä½•å·¥ä½œ?
å½“`ARCH=riscv32-nemu`æ—¶ï¼Œnemuè´Ÿè´£è§£é‡Šæ‰§è¡ŒLiteNESï¼ŒLiteNESè´Ÿè´£è§£é‡Šæ‰§è¡Œ`rom`ï¼Œåƒæ˜¯è™šæ‹ŸæœºåµŒå¥—è™šæ‹Ÿæœºã€‚ï¼ˆæœªæ±‚è¯

### åœ¨NEMUä¸Šè¿è¡ŒNEMU
#### è¯»å–æŒ‰é”®
```
typing_game: io_read(AM_INPUT_KEYBRD) -> read from KBD_ADDR ->
nested-nemu: io_read(AM_INPUT_KEYBRD) -> read from KBD_ADDR ->
       nemu:                             read from SDL lib
```
è¿™é‡Œ`typing_game`å’Œ`nested-nemu`éƒ½æ˜¯è¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹é‡Œçš„ï¼Œ`inl(addr)`çš„ä¸ä¼šæ­»å¾ªç¯å—ï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå› ä¸º`mmio`æ˜¯**è™šæ‹Ÿåœ°å€**æ˜ å°„åˆ°**çœŸå®åœ°å€**ï¼Œä»–ä»¬çš„çœŸå®åœ°å€æ˜¯ä¸åŒçš„ã€‚
#### åˆ·æ–°å±å¹•
```
typing_game: io_write(AM_GPU_FBDRAW, ...) -> write to FB_ADDR ->
nested-nemu: io_write(AM_GPU_FBDRAW, ...) -> write to FB_ADDR ->
       nemu:                                 write to SDL lib
```

### å¿…ç­”é¢˜
#### ç¼–è¯‘ä¸é“¾æ¥(static inline)
`static inline`å£°æ˜ï¼Œå¦‚æœå‡½æ•°æˆåŠŸå†…è”ï¼Œèµ·ä½œç”¨çš„åªä¼šæ˜¯`inline`ï¼Œè€Œ`static inline`æ˜¯ä¸ºäº†ä»£ç å¥å£®æ€§ï¼Œé˜²æ­¢æœ‰äº›ç¼–è¯‘å™¨æ‹’ç»å†…è”ã€‚è¿™ç§æƒ…å†µ`static`å¯ä»¥å…œåº•æŠŠå‡½æ•°ç¼–è¯‘ä¸º`local function`ã€‚æ‰€ä»¥å»æ‰`inline`ä¸ä¼šæŠ¥é”™ï¼Œå»æ‰`static`ä¸ä¸€å®šä¼šæŠ¥é”™ï¼Œå»æ‰ä¸¤è€…ä¸€å®šæŠ¥é”™ã€‚
  
### ç¼–è¯‘ä¸é“¾æ¥()
1. é€šè¿‡`readelf`å¯ä»¥ç»Ÿè®¡åˆ°`dummy`çš„ä¸ªæ•°ï¼Œå¸¦æœ‰é»˜è®¤é•œåƒçš„`riscv32-nemu`æ˜¯34ä¸ª
```shell
â¯ readelf -s build/riscv32-nemu-interpreter|grep dummy
    35: 0000000000026900     4 OBJECT  LOCAL  DEFAULT   27 dummy
    40: 0000000000026980     4 OBJECT  LOCAL  DEFAULT   27 dummy
    49: 0000000000026a60     4 OBJECT  LOCAL  DEFAULT   27 dummy
    53: 0000000000026aa0     4 OBJECT  LOCAL  DEFAULT   27 dummy
...
```
2. æ•°é‡ä¸€æ ·ï¼Œå› ä¸ºæ²¡æœ‰åˆå§‹åŒ–ï¼Œå£°æ˜æ˜¯å¯ä»¥é‡å¤çš„ã€‚
3. ä¼šæŠ¥é‡å¤å®šä¹‰ï¼Œ`error: redefinition of â€˜dummyâ€™`ã€‚ä¹‹å‰æ²¡é‡åˆ°æ˜¯å› ä¸ºç”¨å®éš”ç¦»äº†ã€‚

### åˆå½±ç•™å¿µ

è™½ç„¶åªæœ‰ä¸åˆ°20FPSã€‚å…ˆä¸Šçº¿ï¼Œåä¼˜åŒ–ï¼

![](/images/20230513232544.png)

## ç»“å°¾
PA2ç»“æŸï¼Œè¿›å…¥PA3
---
title: '[JVM]对象的分配回收策略'
author: 土川
tags:
  - JVM
  - GC
categories:
  - Java基础
slug: 476673891
date: 2018-03-29 16:10:00
draft: true
---
> 一个对象被new出来分配在哪呢。一个对象的分配，往大方向上讲，就是在堆分配

<!--more-->
内存分配规则不是固定的，取决于虚拟机参数、GC组合类型

# 对象优先在Eden分配
大多数情况下对象再新生代Eden区中分配，当没有足够的空间时，虚拟机将发起一次Minor GC。
# 大对象直接进入老年代
所谓的大对象就是指需要连续空间的java对象，最典型的是数组和字符串。（应避免短命大对象）
# 长期存活的对象将进入老年代
每个对象有对象年龄（Age）计数器。每次在minor GC后仍存在且能被survivor区容纳的话，年龄就+1（初始为0），达到一个阈值（默认15），就晋升到老年代中
# 动态对象年龄判定
> 并不是必须达到年龄才可以晋升老年代

如果在Survivor空间中，相同年龄所有对象大小总和大于Survivor空间的一半，年龄大于或等于该年龄的对象就可以直接进入老年代。
# 空间分配担保
Minor GC之前，如果**老年代最大可用的连续空间**大于**新生代所有对象总空间**，则GC安全。
否则，检查是否允许担保失败（HandlePromotionFailure的值）。
如果允许，则继续检查**老年代最大可用的连续空间**是否大于**历次晋升到老年代对象的平均大小**。如果大于，则尝试Minor GC。
如果小于或者不允许，则改为Full GC

> jdk 6u24 之后，HandlePromotionFailure已经不影响分配担保策略了。如果**老年代最大可用的连续空间**大于**新生代所有对象总空间**，或者大于**历次晋升到老年代对象的平均大小**，则进行Minor GC，否则Full GC。